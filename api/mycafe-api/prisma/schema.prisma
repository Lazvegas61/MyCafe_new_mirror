generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model billiard_session {
  id              Int             @id @default(autoincrement())
  table_id        Int
  day_id          Int
  start_time      DateTime        @default(now()) @db.Timestamp(6)
  end_time        DateTime?       @db.Timestamp(6)
  status          String          @default("ACTIVE") @db.VarChar(20)
  tariff_id       Int
  tarife_snap     Json
  calculated_fee  Decimal?        @db.Decimal(10, 2)
  invoice_id      Int?
  created_at      DateTime        @default(now()) @db.Timestamp(6)
  daymarker       daymarker       @relation(fields: [day_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  invoice         invoice?        @relation(fields: [invoice_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  cafe_table      cafe_table      @relation(fields: [table_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  billiard_tariff billiard_tariff @relation(fields: [tariff_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([status, day_id], map: "idx_billiard_session_status")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model billiard_tariff {
  id               Int                @id @default(autoincrement())
  name             String             @db.VarChar(100)
  hourly_rate      Decimal            @db.Decimal(10, 2)
  is_active        Boolean            @default(true)
  tariff_data      Json               @default("{}")
  billiard_session billiard_session[]
}

model cafe_table {
  id               Int                @id @default(autoincrement())
  table_number     String             @unique @db.VarChar(10)
  description      String?
  is_active        Boolean            @default(true)
  billiard_session billiard_session[]
  invoice          invoice[]
}

model customer {
  id                 Int                  @id @default(autoincrement())
  name               String               @db.VarChar(100)
  phone              String?              @db.VarChar(20)
  notes              String?
  is_active          Boolean              @default(true)
  created_at         DateTime             @default(now()) @db.Timestamp(6)
  financetransaction financetransaction[]
  invoice            invoice[]
}

model daymarker {
  id                 Int                  @id @default(autoincrement())
  day_date           DateTime             @unique @db.Date
  is_closed          Boolean              @default(false)
  closed_at          DateTime?            @db.Timestamp(6)
  created_at         DateTime             @default(now()) @db.Timestamp(6)
  billiard_session   billiard_session[]
  financetransaction financetransaction[]
  invoice            invoice[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model financetransaction {
  id                          Int                  @id @default(autoincrement())
  transaction_type            String               @db.VarChar(50)
  amount                      Decimal              @db.Decimal(10, 2)
  currency                    String               @default("TRY") @db.VarChar(3)
  day_id                      Int
  invoice_id                  Int?
  customer_id                 Int?
  description                 String?
  created_by                  Int?
  created_at                  DateTime             @default(now()) @db.Timestamp(6)
  debt_related_transaction_id Int?
  users                       users?               @relation(fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  customer                    customer?            @relation(fields: [customer_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  daymarker                   daymarker            @relation(fields: [day_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  financetransaction          financetransaction?  @relation("financetransactionTofinancetransaction", fields: [debt_related_transaction_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_financetransaction    financetransaction[] @relation("financetransactionTofinancetransaction")
  invoice                     invoice?             @relation(fields: [invoice_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([customer_id], map: "idx_financetransaction_customer")
  @@index([day_id], map: "idx_financetransaction_day")
  @@index([transaction_type, day_id], map: "idx_financetransaction_type_day")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model invoice {
  id                 Int                  @id @default(autoincrement())
  invoice_number     String               @unique @db.VarChar(50)
  table_id           Int
  day_id             Int
  is_open            Boolean              @default(true)
  customer_id        Int?
  notes              String?
  created_at         DateTime             @default(now()) @db.Timestamp(6)
  closed_at          DateTime?            @db.Timestamp(6)
  closed_by          Int?
  billiard_session   billiard_session[]
  financetransaction financetransaction[]
  users              users?               @relation(fields: [closed_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  customer           customer?            @relation(fields: [customer_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  daymarker          daymarker            @relation(fields: [day_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  cafe_table         cafe_table           @relation(fields: [table_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  invoiceline        invoiceline[]

  @@index([day_id, is_open], map: "idx_invoice_day_open")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model invoiceline {
  id                 Int              @id @default(autoincrement())
  invoice_id         Int
  line_type          String           @db.VarChar(20)
  product_id         Int?
  product_name_snap  String           @db.VarChar(200)
  unit_price_snap    Decimal          @db.Decimal(10, 2)
  category_name_snap String           @db.VarChar(100)
  quantity           Int
  notes              String?
  created_at         DateTime         @default(now()) @db.Timestamp(6)
  invoice            invoice          @relation(fields: [invoice_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  product            product?         @relation(fields: [product_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  stock_movement     stock_movement[]

  @@index([invoice_id], map: "idx_invoiceline_invoice")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model product {
  id               Int              @id @default(autoincrement())
  name             String           @db.VarChar(200)
  current_price    Decimal          @db.Decimal(10, 2)
  category_id      Int
  is_active        Boolean          @default(true)
  invoiceline      invoiceline[]
  product_category product_category @relation(fields: [category_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  stock            stock[]
  stock_movement   stock_movement[]
}

model product_category {
  id          Int       @id @default(autoincrement())
  name        String    @unique @db.VarChar(100)
  description String?
  product     product[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model stock {
  id               Int      @id @default(autoincrement())
  product_id       Int
  current_quantity Int      @default(0)
  last_updated     DateTime @default(now()) @db.Timestamp(6)
  product          product  @relation(fields: [product_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([product_id], map: "idx_stock_product")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model stock_movement {
  id                     Int          @id @default(autoincrement())
  product_id             Int
  movement_type          String       @db.VarChar(20)
  quantity               Int
  related_invoiceline_id Int?
  notes                  String?
  created_at             DateTime     @default(now()) @db.Timestamp(6)
  product                product      @relation(fields: [product_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  invoiceline            invoiceline? @relation(fields: [related_invoiceline_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([product_id, created_at], map: "idx_stock_movement_product_date")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model user {
  @@map("users")
  id                 Int                  @id @default(autoincrement())
  username           String               @unique @db.VarChar(50)
  password_hash      String               @db.VarChar(255)
  full_name          String               @db.VarChar(100)
  role               String               @db.VarChar(50)
  is_system_admin    Boolean              @default(false)
  is_immutable       Boolean              @default(false)
  is_active          Boolean              @default(true)
  created_at         DateTime             @default(now()) @db.Timestamp(6)
  financetransaction financetransaction[]
  invoice            invoice[]
  usersession        usersession[]

  @@index([role, is_active], map: "idx_users_role_active")
}

model usersession {
  id            Int      @id @default(autoincrement())
  user_id       Int
  session_token String   @unique @db.VarChar(255)
  ip_address    String?  @db.Inet
  user_agent    String?
  created_at    DateTime @default(now()) @db.Timestamp(6)
  expires_at    DateTime @default(dbgenerated("(now() + '08:00:00'::interval)")) @db.Timestamp(6)
  last_activity DateTime @default(now()) @db.Timestamp(6)
  is_active     Boolean  @default(true)
  users         users    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}
